<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>CAN Bus Hardware Addition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Joshua Vasquez">

    <!-- Le styles -->
    <link href="../../assets/css/bootstrap-custom.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>
    <link href="../../assets/css/bootstrap-responsive.css" rel="stylesheet">


    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../../assets/ico/apple-touch-icon-114-precomposed.png">
      <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../../assets/ico/apple-touch-icon-72-precomposed.png">
                    <link rel="apple-touch-icon-precomposed" href="../../assets/ico/apple-touch-icon-57-precomposed.png">
                                   <link rel="shortcut icon" href="../../assets/ico/favicon.png">
    <!-- Custom Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Days+One|Titillium+Web' rel='stylesheet' type='text/css'>

  </head>

   <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="../../../index.html">Joshua Vasquez</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li><a href="../about.html">About</a></li>
              <li><a href="../projectsList.html">Projects</a></li>
              <li><a href="../Research.html">Research</a></li>
              <li><a href="../tutorialsList.html">Tutorials</a></li>
              <li><a href="../resources.html">Resources</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

<body data-spy="scroll" data-target=".bs-docs-sidebar">




<div class="span9">



<!--
<h3 style="text-align: center;">The Two-Axis Gantry</h3>
<center>
<img src="../../assets/img/Projects/twoAxisGantry/twoAxisGantry.png" width=600>
</center>
-->

<div class="span9" >
<h3 style="text-align: center;">CAN Bus Hardware Device</h3>
<h4 style="text-align: center;">An Embedded System for non-invasively probing CAN Bus 
    packets and rotating a sonar underwater</h4>
<p style="text-align:center">
<img src="../../assets/img/Projects/CANBusDevice/fullBoard.jpg" width=500>
</p>
</div>


<h3>Introduction</h3>

<p>
In fall, 2012, I was admitted to
Harvey Mudd College's Lab for Autonomous and Intelligent Robotics, 
<a href="http://newwww.hmc.edu/lair/">LAIR</a>, in its first year of operation. 
Through the ICEX program, I began developing additional hardware for the 
underwater robot platform used on deployments, a Videoray Pro III.
</p>

<h3>Background</h3>
<div class="span9" >
<h4> The Malta Cistern Mapping Project</h4>
</p>
The International Computer Engineering Experience (ICEX) Program is a 
multi-disciplinary, multi-year project focused on the three-dimensional 
mapping of ancient archaeological sites. 
</p>
<p>
<p style="text-align:center">
<img src="../../assets/img/Projects/CANBusDevice/malta.jpg" width=700>
<p>
The country of Malta itself lies just off the coast of Italy. In ancient times, 
it remained a primary target for invaders, as it's location made it an 
excellent stepping stone to the neighboring mainland.  Consequently, a number
of invaders have briefly inhabited the island over the past two-thousand years.
</p>
</div>
<div class="span9" >
<img src="../../assets/img/Projects/CANBusDevice/leapFrogging.jpg" width=450 align="left" Hspace=10>
<img src="../../assets/img/Projects/CANBusDevice/rovScans2.jpg" width=300 align="left" Hspace=10>
</div>
<div class="span9" >
<p>
In its most recent years, the ICEX research team has traveled to Malta
to reconstruct submerged ancient cisterns, many of which have not been seen
for over a thousand years. Archaeologists benefit from a project of this
manner as a 3D reconstruction can tell a well-versed archaelogist several 
features about its users, such as their identity and local time period of 
inhabitance.
</p>
<p>
This past year, three fellow classmates, Professor Clark, and I traveled to
Malta to collect data from three cisterns over the course of ten days. 
Overlapping stationary scans were collected within each cistern until we
had ensured full coverage of the cistern using the onboard camera.  
</p>
<p>
During the summer, we published 
<a href="http://newwww.hmc.edu/lair/publications/2013/dobke_UUST_2013.pdf">
Towards Three-Dimensional Mapping without Odometry</a>, a paper describing 
the Lattice Map algorithm.  The algorithm itself performs a least-squares 
fitting on sequential scans based on a probabilistic scan-matching 
approach, ultimately generating a three-dimensional map from the raw data. 
</p>
</div>
<div class="span9" >
<img src="../../assets/img/Projects/CANBusDevice/latticeMap.jpg" width="345" align="left" Hspace=10 Vspace=15>
<img src="../../assets/img/Projects/CANBusDevice/marchingCubes.jpg" width="375" align="left" Hspace=10 Vspace=15>
</div>
<p>
Above, the images depict the raw output of the lattice Map algorithm, and
a rendering generated with the Marching Cubes algortihm by collaborators
in CalPoly San Luis Obispo.
</p>

<div class="span9">
<h4> The Platform of Choice: a Videoray Pro III</h4>
<img src="../../assets/img/Projects/CANBusDevice/robot.jpg" width="450" align="left" Hspace=10 Vspace=15>
<p>
To navigate the narrow passageways of the ancient cisterns, we deployed a 
Videoray Pro III remotely-operated vehicle (ROV). Traditional control 
involves control through a tethered control box. 
However, the box also features a computer-control feature through a serial
interface. Therefore, our team developed drivers in the Linux-based Robot 
Operating System (ROS) to handle both user-control of the ROV and 
data collection from the sonars.
</p>
<p>
To collect both horizontal
and vertical scans, two Tritech Sonars were mounted perpendicular to each
other at the front of the robot.  In this sense, both horizontal and 
vertical scans could be collected at a single stationary scan point.  
</p>
</div>

<div class="span9">
<h4> The Hardware Development Goal for the 2014 Deployment</h4>
<p>
Currently two sonars are used to collect both horizontal and vertical scans
at a single scan point.  For this reason, scans collected are only sparse
representations of the true features of the cistern, and interpolation is 
required to generate closed three-dimensional maps.  To resolve this issue,
I have prototyped a rotating sonar mount. This project  consists of 
three main components: mechanical design, featuring waterproof hardware; 
electronics hardware design, featuring a fabricated circuit board, 
and a modified software driver to control the additional hardware once 
mounted on the robot. 
</p>

</div>

<h3> The Design</h3>
<div class="span9">
<h4> Electronics Hardware Design</h4>
<h5> Parsing the Robot Communication Protocol</h5>
<p>
The signal communication between ROV and user control box is handled by a 
CAN Bus interface, strung through a waterproof tether. This tether also carries 
power and video signals, as well as communication signals for serial accessories. 
</p>
<p>
The natural location to insert the rotating sonar mount accessory would 
appear to be through the serial accessory lines on the ROV tether.  
However, two daisy-chained sonars were implemented on these
signals, hogging the majority of the bandwidth and ultimately necessary as a real-time 
vision-aid for the ROV driver.  The remaining solution was to send
signals to communicate along the same lines as the ROV's control signals. These signals 
implement a tight CAN Bus closed-feedback loop between the ROV and the control box.  
<center>
<img src="../../assets/img/Projects/CANBusDevice/blockDiagram.svg"  align="middle" Hspace=10 Vspace=15>
</center>
</p>
<h5> Probing for an Interface to the Sonar Mount</h5>
<p>
The CAN Bus interface, at the high-level, can string numerous devices along the same bus.
The master can communicate with each of these devices individually through an addressing
scheme.  Unfortunately, for the ROV, the master was the control box, an expensive system 
which could not be reprogrammed to accept additional slave devices on the CAN Bus interface
between the control box and ROV.  
</p>
<p>
However, after further probing, I discovered that the packet sent from the control box to the
ROV to the CAN Bus contained several unused bits; enough, in fact, to devise a protocol for 
the sonar mount.  If the sonar mount could read these bits, then it could respond to the  
data sent from the controller by rotating the mount by the desired amount.
</p>
<p>
Due to the nature of the CAN Bus protocol, however, devices that are addressed by the master
must acknowledge that they have received the packet. Thus, I could not simply program the 
sonar mount accessory with the same address as the ROV, or both devices would attempt to 
acknowledge the same packet, originally intended for just the ROV. The solution? To silently
acknowledge the packet of the ROV. This capability is, in fact, possible using the MCP2515
CAN Controller IC. Thus, the schematic for CAN Bus interfacing is as follows:
</p>
<center>
<img src="../../assets/img/Projects/CANBusDevice/arduinoCAN_Mod_CAN_Interface.svg"  align="middle" Hspace=10 Vspace=15>
</center>
<p>
From left to right, the raw CAN Bus signals are first sent to the MCP2551, which maps the differential 
voltage signals to TTL logic levels acceptable by several digital ICs. The MCP2515 then parses this
packet and stores the data in internal registers. Through an SPI interface, An Atmega328 microcontroller
(not shown) then drives a servo, connected to the sonar mount, to the appropriate angle. For brevity, 
the 
<a href="../../assets/img/Projects/CANBusDevice/arduinoCAN_Mod.pdf">full schematic</a> is not
shown.
</p>

<h5> A small form-factor PCB</h5>

<center>
<img src="../../assets/img/Projects/CANBusDevice/arduinoCAN_Mod.jpg" width="400" align="middle" Hspace=10 Vspace=15>
</center>
<p>
The hardware task was well-defined: develop a hardware interface to 
probe the CAN Bus communication line without actively replying to 
CAN messages directed at the robot. 
Furthermore, due to the small-form-factor of the sonar mount on the outside of the robot, a small pcb was developed to fit inside the waterproof 
housing. To save time, I opted to etch the control board, rather than send it out.
</p>
<div class="span9">
<img src="../../assets/img/Projects/CANBusDevice/pcbPrints.jpg" width="400" align="left" Hspace=10 Vspace=15>
<img src="../../assets/img/Projects/CANBusDevice/vias.jpg" width="400" align="left" Hspace=10 Vspace=15>
</div>
<h4> Mechanical Design</h4>
<h5> O-Ring Sealing</h5>
<p>
Two openings pose a threat for leaks on the outside of the waterproof
housing: the shaft opening, where the sonar rotates, and the case opening,
from which the electronics and servo are inserted. To ensure an underwater
seal at a depth of 50 ft, I chose two types of o-ring seals: a ring seal 
for rotating components, and a typical o-ring seal for the lid.
The main lid of the box (shown below) is fixed with a typical O-ring seal, where groove depths
were calculated with the 
<a href="http://www.parker.com/literature/ORD%205700%20Parker_O-Ring_Handbook.pdf">Parker O-ring Manual</a>.
</p>
<h5> Designing for Field Wear</h5>
<div class="span9">
<img src="../../assets/img/Projects/CANBusDevice/finalBox.jpg" width="400" align="left" Hspace=10 Vspace=15>
<img src="../../assets/img/Projects/CANBusDevice/finalBoxDetail.jpg" width="400" align="left" Hspace=10 Vspace=15>
</div>
<p>
Since the box would be repeatedly opened for maintenance and inspection
of the circuitry, this particular lid sealing is ideal, as it does not 
induce severe mechanical wear on the box each time it is opened.  
Additionally, no screws are threaded into the plastic housing; rather, 
two bolts apply compressive force from opposing ends of the box.
</p>

<h4> Software Driver Modification</h4>
<p>
The ROV is ultimately controlled by a software driver implemented in Python.
This driver constructs the data packets sent to the ROV to control 
speed and direction of both motors.  Within this driver, I added additional 
software control to control the new sonar Mount 
</p>
<center>
<img src="../../assets/img/Projects/CANBusDevice/blockDiagramFull.svg"  align="middle" Hspace=10 Vspace=15>
</center>

<h4> Testing </h4>
<p>
This device is currently in its final stages of testing.  A full underwater test will be conducted before 
December 15th.
</p>

</div>





</div>

    <div class="container">
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../assets/js/jquery.js"></script>
    <script src="../assets/js/bootstrap-transition.js"></script>
    <script src="../assets/js/bootstrap-alert.js"></script>
    <script src="../assets/js/bootstrap-modal.js"></script>
    <script src="../assets/js/bootstrap-dropdown.js"></script>
    <script src="../assets/js/bootstrap-scrollspy.js"></script>
    <script src="../assets/js/bootstrap-tab.js"></script>
    <script src="../assets/js/bootstrap-tooltip.js"></script>
    <script src="../assets/js/bootstrap-popover.js"></script>
    <script src="../assets/js/bootstrap-button.js"></script>
    <script src="../assets/js/bootstrap-collapse.js"></script>
    <script src="../assets/js/bootstrap-carousel.js"></script>
    <script src="../assets/js/bootstrap-typeahead.js"></script>

  </body>
</html>
